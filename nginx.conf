events { worker_connections 1024; }

http {

    upstream kms_backend {
        server kms-monitoring-kms-1:9998;
        server kms-monitoring-kms-2:9998;
    }

    # --- Serveur HTTPS normal ---
    server {
        listen 443 ssl;

        ssl_certificate /etc/nginx/certs/kms-cert.pem;
        ssl_certificate_key /etc/nginx/certs/kms-key.pem;

        add_header X-Upstream-Server $upstream_addr always;

        location / {
            proxy_pass https://kms_backend/;
            proxy_ssl_verify off;
        }

        location /ui {
            proxy_pass https://kms_backend/ui;
            proxy_ssl_verify off;
        }
    }

    # --- Serveur HTTP interne pour metrics/logs ---
    server {
        listen 8080;
        server_name localhost;

        # On garde stub_status pour compatibilit√© mais logs sont prioritaires
        location /metrics {
            stub_status;
            allow all;
        }
    }

    # --- Logs avec upstream ---
    log_format upstream '$remote_addr [$time_local] "$request" $status upstream=$upstream_addr urt=$upstream_response_time';
    access_log /var/log/nginx/access.log;
}