---
# OpenTelemetry Collector Configuration
# This collector receives KMS metrics via OTLP and exports to configured backends
#
# Usage:
#   1. Install OTLP Collector: https://opentelemetry.io/docs/collector/installation/
#   2. Run: otelcol --config=otel-collector-config.yaml
#   3. The collector will receive OTLP metrics from KMS server
#   4. Metrics are exported to your configured OTLP endpoint (Jaeger, etc.)

receivers:
  # Receive OTLP metrics directly from KMS server
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318


processors:
  # Batch metrics for better performance
  batch:
    timeout: 10s
    send_batch_size: 1024
    send_batch_max_size: 2048

  # Add resource attributes
  resource:
    attributes:
      - key: service.name
        value: cosmian_kms
        action: upsert
      - key: service.version
        value: ${env:KMS_VERSION}
        action: upsert
      - key: deployment.environment
        value: ${env:ENVIRONMENT}
        action: upsert

exporters:
  # Export to your OTLP backend (Jaeger, cloud providers, etc.)
  otlp:
    endpoint: ${env:OTLP_ENDPOINT}
    tls:
      insecure: true
    compression: gzip
    sending_queue:
      enabled: true
      num_consumers: 10
      queue_size: 5000
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s
    headers:
      # Add any required authentication headers
      # api-key: ${OTLP_API_KEY}

  # OTLP over HTTP exporter (useful for simple backends / CI mocks)
  otlphttp:
    endpoint: http://${env:OTLP_ENDPOINT}
    tls:
      insecure: true
    compression: none

  # Optional: Log metrics for debugging
  debug:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

  # Expose metrics in Prometheus text format.
  prometheus:
    endpoint: 0.0.0.0:8889


service:
  pipelines:
    # Metrics pipeline: OTLP receive â†’ OTLP export
    metrics:
      receivers: [otlp]
      processors: [resource, batch]
      exporters: [prometheus, otlphttp, debug]

    # Traces pipeline
    traces:
      receivers: [otlp]
      processors: [resource, batch]
      exporters: [otlphttp]

  # Enable telemetry for the collector itself
  telemetry:
    logs:
      level: info
    metrics:
      level: detailed
