#!/bin/sh -ex

has_systemd() {
  command -v systemctl >/dev/null 2>&1 && [ -d /run/systemd/system ]
}

# Restore existing configuration
KMS_CONFIG="/etc/cosmian/kms.toml.bak"
if [ -f $KMS_CONFIG ]; then
  mkdir -p /etc/cosmian
  cp $KMS_CONFIG /etc/cosmian/kms.toml
fi

# Service management is handled by the deb-systemd-* helpers that cargo-deb
# injects below. Avoid hard-failing on environments without systemd (containers,
# WSL, chroots).
if has_systemd; then
  systemctl daemon-reload >/dev/null 2>&1 || true
fi

# Restore UI branding overrides (if any)
UI_DIST="/usr/local/cosmian/ui/dist"
UI_BACKUP_DIR="/var/lib/cosmian/ui"
if [ -d "$UI_DIST" ]; then
  if [ -f "$UI_BACKUP_DIR/branding.json.bak" ]; then
    if [ ! -f "$UI_DIST/branding.json" ]; then
      cp "$UI_BACKUP_DIR/branding.json.bak" "$UI_DIST/branding.json"
    else
      if ! cmp -s "$UI_BACKUP_DIR/branding.json.bak" "$UI_DIST/branding.json"; then
        cp "$UI_BACKUP_DIR/branding.json.bak" "$UI_DIST/branding.json.dpkg-old"
      fi
    fi
  fi

  if [ -d "$UI_BACKUP_DIR/themes.bak" ]; then
    if [ ! -d "$UI_DIST/themes" ]; then
      cp -R "$UI_BACKUP_DIR/themes.bak" "$UI_DIST/themes"
    else
      cp -R "$UI_BACKUP_DIR/themes.bak" "$UI_DIST/themes.dpkg-old"
    fi
  fi
fi

#DEBHELPER#
