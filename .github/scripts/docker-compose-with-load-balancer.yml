---
# CI/dev helper: multiple KMS instances behind an Nginx load balancer,
# sharing a single PostgreSQL database.
#
# Goal: verify the load balancer can serve `/health`.
#
# Usage:
#   docker compose -f .github/scripts/docker-compose.yml up -d
#   curl -fsS http://localhost:8080/health

name: scripts

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: kms
      POSTGRES_PASSWORD: kms
      POSTGRES_DB: kms
    ports:
      - 5432:5432
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [CMD-SHELL, pg_isready -U kms -d kms]
      interval: 5s
      timeout: 5s
      retries: 30

  # KMS instances. We assume the server listens on HTTP 0.0.0.0:9998 by default.
  # If your server is TLS-only in your deployment, you can still keep this as plain HTTP
  # for local smoke tests, or update Nginx to proxy_pass https://... with cert config.
  kms1:
    image: ${DOCKER_IMAGE_NAME}
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      KMS_POSTGRES_URL: postgresql://kms:kms@postgres:5432/kms
      # If supported by the image, explicitly set database type.
      # Otherwise the URL alone may be enough.
      KMS_DATABASE_TYPE: postgres
      # Only one instance should clear/init DB.
      KMS_CLEAR_DATABASE: 'true'
    command:
      - --database-type=postgresql
      - --database-url=postgresql://kms:kms@postgres:5432/kms
      # Optional for local runs: clear DB when starting kms1.
      # In CI you likely want this enabled, but it must be done by a single instance.
      # Prefer setting `KMS_CLEAR_DATABASE=1` for kms1 only.
    expose:
      - '9998'
    healthcheck:
      test: [CMD-SHELL, "wget -qO- http://localhost:9998/health >/dev/null 2>&1 || wget -qO- --post-data='{}' --header='Content-Type: application/json'\
            \ http://localhost:9998/kmip/2_1 >/dev/null 2>&1"]
      interval: 5s
      timeout: 5s
      retries: 60

  kms2:
    image: ${DOCKER_IMAGE_NAME}
    depends_on:
      kms1:
        condition: service_healthy
    environment:
      KMS_POSTGRES_URL: postgresql://kms:kms@postgres:5432/kms
      KMS_DATABASE_TYPE: postgres
    command:
      - --database-type=postgresql
      - --database-url=postgresql://kms:kms@postgres:5432/kms
    expose:
      - '9998'
    healthcheck:
      test: [CMD-SHELL, "wget -qO- http://localhost:9998/health >/dev/null 2>&1 || wget -qO- --post-data='{}' --header='Content-Type: application/json'\
            \ http://localhost:9998/kmip/2_1 >/dev/null 2>&1"]
      interval: 5s
      timeout: 5s
      retries: 60

  kms3:
    image: ${DOCKER_IMAGE_NAME}
    depends_on:
      kms1:
        condition: service_healthy
    environment:
      KMS_POSTGRES_URL: postgresql://kms:kms@postgres:5432/kms
      KMS_DATABASE_TYPE: postgres
    command:
      - --database-type=postgresql
      - --database-url=postgresql://kms:kms@postgres:5432/kms
    expose:
      - '9998'
    healthcheck:
      test: [CMD-SHELL, "wget -qO- http://localhost:9998/health >/dev/null 2>&1 || wget -qO- --post-data='{}' --header='Content-Type: application/json'\
            \ http://localhost:9998/kmip/2_1 >/dev/null 2>&1"]
      interval: 5s
      timeout: 5s
      retries: 60

  nginx-load-balancer:
    image: nginx:1.27-alpine
    depends_on:
      - kms1
      - kms2
      - kms3
    ports:
      - 18080:8080
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro

volumes:
  postgres-data:
