---
name: Packaging - Tests

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string
        default: 1.90.0
  workflow_dispatch:
    inputs:
      toolchain:
        description: Rust toolchain to use (e.g., stable, nightly-YYYY-MM-DD)
        required: true
        type: string
        default: 1.90.0

jobs:
  packages-test:
    name: In Docker ${{ matrix.container }}-${{ matrix.features }}-${{ matrix.link }}${{ matrix.runner == 'ubuntu-24.04-arm' && '-ARM' || '-AMD64' }}
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        container:
          # Ubuntu LTS releases within the last ~10 years
          - ubuntu:25.04
          - ubuntu:24.04
          - ubuntu:22.04
          # Debian stable releases within the last ~10 years
          - debian:trixie-slim # Debian 13
          - debian:bookworm-slim # Debian 12
          # Rocky Linux releases
          - rockylinux/rockylinux:10
          - rockylinux/rockylinux:9
        features: [fips, non-fips]
        link: [static, dynamic]
        runner: [ubuntu-24.04, ubuntu-24.04-arm]

    steps:
      - name: Download package artifacts
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.features }}_${{ matrix.link }}_${{ matrix.runner }}-release

      - name: List downloaded artifacts
        run: find .

      - name: Install package
        shell: bash
        run: |
          set -ex
          if [ "${{ startsWith(matrix.container, 'rockylinux') }}" = "true" ]; then
            # RPM-based (Rocky Linux)
            rpm -qpl ./result-rpm-${{ matrix.features }}-${{ matrix.link }}/*.rpm
            rpm -i ./result-rpm-${{ matrix.features }}-${{ matrix.link }}/*.rpm --nodeps || true
          else
            # DEB-based (Ubuntu/Debian)
            dpkg --contents ./result-deb-${{ matrix.features }}-${{ matrix.link }}/*.deb
            # Use apt to handle dependencies when installing local .deb files
            dpkg -i ./result-deb-${{ matrix.features }}-${{ matrix.link }}/*.deb || true
          fi

      - name: Enable info flag in config
        shell: bash
        run: |
          set -ex
          if [ -f /etc/cosmian/kms.toml ]; then
            sed -i 's/info = false/info = true/g' /etc/cosmian/kms.toml
          else
            echo "Config file /etc/cosmian/kms.toml not found; skipping info flag enable."
            exit 1
          fi

      - name: Pre-check file
        shell: bash
        run: |
          set -ex
          # Ensure OpenSSL uses packaged config and modules
          export OPENSSL_CONF="/usr/local/cosmian/lib/ssl/openssl.cnf"
          export OPENSSL_MODULES="/usr/local/cosmian/lib/ossl-modules"
          # Determine installed binary path
          BIN="/usr/sbin/cosmian_kms"
          if [ ! -x "$BIN" ]; then
            if [ -f "/usr/bin/cosmian_kms" ]; then
              BIN="/usr/bin/cosmian_kms"
            fi
          fi
          # Show libs and run
          ldd "$BIN"
          chmod +x "$BIN"
          "$BIN" --version
          "$BIN" --info

      - name: Disable info flag in config
        shell: bash
        run: |
          set -ex
          if [ -f /etc/cosmian/kms.toml ]; then
            sed -i 's/info = true/info = false/g' /etc/cosmian/kms.toml
          else
            echo "Config file /etc/cosmian/kms.toml not found; skipping info flag enable."
            exit 1
          fi

      - name: Run executable file
        shell: bash
        run: |
          set -ex
          # Ensure OpenSSL uses packaged config and modules
          export OPENSSL_CONF="/usr/local/cosmian/lib/ssl/openssl.cnf"
          export OPENSSL_MODULES="/usr/local/cosmian/lib/ossl-modules"
          # Determine installed binary path
          BIN="/usr/sbin/cosmian_kms"
          "$BIN" &
          sleep 5

          # Test UI endpoints
          if command -v curl >/dev/null 2>&1; then
            curl -I http://127.0.0.1:9998/ui/index.html
          else
            # Last resort: pure Bash using /dev/tcp
            # Requires bash; sends a HEAD request and checks for 200
            set +e
            {
              exec 3<>/dev/tcp/127.0.0.1/9998
              printf 'HEAD /ui/index.html HTTP/1.1\r\nHost: 127.0.0.1\r\nConnection: close\r\n\r\n' >&3
              read -r status_line <&3
              echo "$status_line"
              echo "$status_line" | grep -qE 'HTTP/.* 2[0-9]{2}\b'
            } ; rc=$?
            exec 3>&- 3<&-
            set -e
            exit $rc
          fi

  systemd-packages-test:
    name: Use GH runners ${{ matrix.features }}-${{ matrix.link }}${{ matrix.runner == 'ubuntu-24.04-arm' && '-ARM' || '-AMD64' }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        features: [fips, non-fips]
        link: [static, dynamic]
        runner: [ubuntu-24.04, ubuntu-24.04-arm]

    steps:
      - name: Download package artifacts
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.features }}_${{ matrix.link }}_${{ matrix.runner }}-release

      - name: List downloaded artifacts
        run: find .

      - name: Install package
        shell: bash
        run: |
          set -ex
          # DEB-based (Ubuntu/Debian)
          dpkg --contents ./result-deb-${{ matrix.features }}-${{ matrix.link }}/*.deb
          # Use apt to handle dependencies when installing local .deb files
          sudo dpkg -i ./result-deb-${{ matrix.features }}-${{ matrix.link }}/*.deb || true

      - name: systemd-analyze security cosmian_kms.service
        shell: bash
        run: |
          set -ex
          systemd-analyze security cosmian_kms.service

      - name: Enable info flag in config
        shell: bash
        run: |
          set -ex
          if [ -f /etc/cosmian/kms.toml ]; then
            sudo sed -i 's/info = false/info = true/g' /etc/cosmian/kms.toml
          else
            echo "Config file /etc/cosmian/kms.toml not found; skipping info flag enable."
            exit 1
          fi

      - name: Pre-check file
        shell: bash
        run: |
          set -ex
          # Ensure OpenSSL uses packaged config and modules
          export OPENSSL_CONF="/usr/local/cosmian/lib/ssl/openssl.cnf"
          export OPENSSL_MODULES="/usr/local/cosmian/lib/ossl-modules"
          # Determine installed binary path
          BIN="/usr/sbin/cosmian_kms"
          if [ ! -x "$BIN" ]; then
            if [ -f "/usr/bin/cosmian_kms" ]; then
              BIN="/usr/bin/cosmian_kms"
            fi
          fi
          # Show libs and run
          sudo ldd "$BIN"
          sudo chmod +x "$BIN"
          sudo -E "$BIN" --version
          sudo -E "$BIN" --info

      - name: Disable info flag in config
        shell: bash
        run: |
          set -ex
          if [ -f /etc/cosmian/kms.toml ]; then
            sudo sed -i 's/info = true/info = false/g' /etc/cosmian/kms.toml
          else
            echo "Config file /etc/cosmian/kms.toml not found; skipping info flag enable."
            exit 1
          fi

      - name: systemctl start cosmian_kms
        shell: bash
        run: |
          set -ex

          sudo systemctl start cosmian_kms
          sleep 30

          # Check systemd service status
          sudo systemctl status cosmian_kms --no-pager || true
          if ! systemctl is-active --quiet cosmian_kms; then
            echo "ERROR: cosmian_kms service is not active"
            sudo systemctl status cosmian_kms --no-pager || true
            sudo journalctl -u cosmian_kms --no-pager -n 200 || true
            exit 1
          fi

          # Test UI endpoints
          if command -v curl >/dev/null 2>&1; then
            curl -I http://127.0.0.1:9998/ui/index.html
          else
            # Last resort: pure Bash using /dev/tcp
            # Requires bash; sends a HEAD request and checks for 200
            set +e
            {
              exec 3<>/dev/tcp/127.0.0.1/9998
              printf 'HEAD /ui/index.html HTTP/1.1\r\nHost: 127.0.0.1\r\nConnection: close\r\n\r\n' >&3
              read -r status_line <&3
              echo "$status_line"
              echo "$status_line" | grep -qE 'HTTP/.* 2[0-9]{2}\b'
            } ; rc=$?
            exec 3>&- 3<&-
            set -e
            exit $rc
          fi

      - name: Create keys with cosmian CLI
        shell: bash
        run: |
          set -euo pipefail

          # Ensure the desired CLI version is available.
          CLI_VERSION="${CLI_VERSION:-1.8.1}"
          if ! command -v cosmian >/dev/null 2>&1; then
            if command -v cargo >/dev/null 2>&1; then
              cargo install cosmian_cli --locked --version "$CLI_VERSION" --force
            else
              echo "ERROR: cosmian CLI not found and cargo is not available to install it." >&2
              exit 1
            fi
          fi

          cosmian --version

          # Configure cosmian CLI to talk to the locally running KMS.
          mkdir -p "$HOME/.cosmian"
          COSMIAN_CONFIG="$HOME/.cosmian/ci-kms.toml"
          cat >"$COSMIAN_CONFIG" <<'TOML'
          [kms_config]
          print_json = false

          [kms_config.http_config]
          server_url = "http://127.0.0.1:9998"
          TOML

          # Create one key of each type.
          cosmian -c "$COSMIAN_CONFIG" kms sym keys create --algorithm aes --number-of-bits 256 ci_sym_key

      - name: Override branding.json and verify served
        shell: bash
        run: |
          set -euo pipefail

          BRANDING_FILE="/usr/local/cosmian/ui/dist/branding.json"
          if [ ! -f "$BRANDING_FILE" ]; then
            echo "ERROR: branding file not found: $BRANDING_FILE" >&2
            sudo find /usr/local/cosmian -maxdepth 5 -type f -name branding.json -print || true
            exit 1
          fi

          export MARKER="CI_BRANDING_OVERRIDE_${GITHUB_RUN_ID}_${GITHUB_RUN_ATTEMPT}_$(date +%s)"
          echo "Using marker: $MARKER"

          # Update JSON safely (avoid brittle sed on JSON)
          sudo env MARKER="$MARKER" python3 - <<'PY'
          import json
          from pathlib import Path
          path = Path("/usr/local/cosmian/ui/dist/branding.json")
          data = json.loads(path.read_text(encoding="utf-8"))
          marker = __import__("os").environ["MARKER"]
          # This field is rendered on the login page; also easy to assert via /ui/branding.json
          data["loginSubtitle"] = marker
          path.write_text(json.dumps(data, indent=2, sort_keys=True) + "\n", encoding="utf-8")
          PY
          sudo -E systemctl restart cosmian_kms
          sleep 3

          if ! systemctl is-active --quiet cosmian_kms; then
            echo "ERROR: cosmian_kms service is not active after restart" >&2
            sudo systemctl status cosmian_kms --no-pager || true
            sudo journalctl -u cosmian_kms --no-pager -n 100 || true
            exit 1
          fi

          # Verify the served branding contains our marker (use cache-busting query param).
          curl -fsS "http://127.0.0.1:9998/ui/branding.json?cb=${MARKER}" | tee /tmp/branding.json | grep -F "${MARKER}" >/dev/null

          # Also verify at least one referenced asset URL resolves (proves theme URLs work).
          python3 - <<'PY'
          import json, os, subprocess
          marker = os.environ["MARKER"]
          with open("/tmp/branding.json", "r", encoding="utf-8") as f:
            data = json.load(f)
          # Prefer logos as they should exist in the packaged theme.
          candidates = [data.get("logoLightUrl"), data.get("logoDarkUrl"), data.get("faviconUrl")]
          url = next((u for u in candidates if isinstance(u, str) and u.startswith("/ui/")), None)
          if not url:
            raise SystemExit("ERROR: no /ui/... asset URL found in branding.json to validate")
          full = f"http://127.0.0.1:9998{url}?cb={marker}"
          subprocess.check_call(["curl", "-fsSI", full])
          print(f"Validated asset: {full}")
          PY
