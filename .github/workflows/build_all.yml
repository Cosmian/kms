---
name: Build all

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string

jobs:
  centos7-tests:
    uses: ./.github/workflows/build_centos7.yml
    secrets: inherit
    with:
      toolchain: ${{ inputs.toolchain }}
      archive-name: centos7_tests
      commands: |
        cargo build --bins
        RUST_MIN_STACK=4194304 cargo test --workspace -- --nocapture
      artifacts: ''

  rhel9-tests:
    uses: ./.github/workflows/build_rhel9.yml
    secrets: inherit
    with:
      toolchain: ${{ inputs.toolchain }}
      archive-name: rhel9_tests
      commands: |
        cargo build --bins
        cargo test --workspace -- --nocapture
      artifacts: ''

  fips-centos7-test:
    uses: ./.github/workflows/build_centos7.yml
    secrets: inherit
    with:
      toolchain: ${{ inputs.toolchain }}
      archive-name: fips_centos7_tests
      commands: |
        cargo build --bins --features fips
        RUST_MIN_STACK=4194304 cargo test --workspace --features fips -- --nocapture
      artifacts: ''

  ubuntu-20-tests:
    uses: ./.github/workflows/build_generic.yml
    secrets: inherit
    with:
      toolchain: ${{ inputs.toolchain }}
      distribution: ubuntu-20.04
      archive-name: ubuntu_20_04_tests
      commands: |
        cargo build --bins
        RUST_MIN_STACK=4194304 cargo test --workspace -- --nocapture --skip test_mysql --skip test_pgsql --skip test_redis
      artifacts: ''

  fips-ubuntu-20-tests:
    uses: ./.github/workflows/build_generic.yml
    secrets: inherit
    with:
      toolchain: ${{ inputs.toolchain }}
      distribution: ubuntu-20.04
      archive-name: fips_ubuntu_20_04_tests
      commands: |
        cargo build --bins --features fips
        RUST_MIN_STACK=4194304 cargo test --workspace --features fips -- --nocapture --skip test_mysql --skip test_pgsql --skip test_redis
      artifacts: ''

  ubuntu-22-tests:
    uses: ./.github/workflows/build_generic.yml
    secrets: inherit
    with:
      toolchain: ${{ inputs.toolchain }}
      distribution: ubuntu-22.04
      archive-name: ubuntu_22_04_tests
      commands: |
        cargo build --bins
        RUST_MIN_STACK=4194304 cargo test --workspace -- --nocapture --skip test_mysql --skip test_pgsql --skip test_redis
      artifacts: ''
