---
name: Push artifacts to package.cosmian.com

on:
  workflow_call:
    inputs:
      project-name:
        required: true
        type: string
      destination:
        required: true
        type: string
      debug_or_release:
        required: true
        type: string

jobs:
  ##############################################################################
  ### Packages
  ##############################################################################
  packages:
    name: push ${{ inputs.project-name }} to package.cosmian.com
    runs-on: [self-hosted, not-sgx]
    container:
      image: cosmian/docker_doc_ci
      volumes:
        - /home/cosmian/.ssh/id_rsa:/root/.ssh/id_rsa

    # Each artifact contains 1 Debian package + 1 RPM package (now doubled for static and dynamic)
    env:
      ARCHIVE_NAMES: >-
        fips_static_ubuntu-24.04-${{ inputs.debug_or_release }}/result-*
        fips_dynamic_ubuntu-24.04-${{ inputs.debug_or_release }}/result-*
        non-fips_static_ubuntu-24.04-${{ inputs.debug_or_release }}/result-*
        non-fips_dynamic_ubuntu-24.04-${{ inputs.debug_or_release }}/result-*
        fips_static_ubuntu-24.04-arm-${{ inputs.debug_or_release }}/result-*
        fips_dynamic_ubuntu-24.04-arm-${{ inputs.debug_or_release }}/result-*
        non-fips_static_ubuntu-24.04-arm-${{ inputs.debug_or_release }}/result-*
        non-fips_dynamic_ubuntu-24.04-arm-${{ inputs.debug_or_release }}/result-*
        non-fips_static_macos-15-${{ inputs.debug_or_release }}/result-*
        non-fips_dynamic_macos-15-${{ inputs.debug_or_release }}/result-*
        windows-release

    steps:
      - run: rm -rf ${{ inputs.project-name }}_* fips_* windows* ubuntu* macos* rockylinux* debian* cargo-* hash-*
      - uses: actions/download-artifact@v6
        with:
          pattern: '*fips*'
      - uses: actions/download-artifact@v6
        with:
          pattern: windows-release
      - uses: actions/download-artifact@v6
        with:
          pattern: hash-*

      - run: find .

      - name: Fail if expected number of packages is incorrect
        shell: bash
        run: |
          set -ex
          DEB_COUNT=0
          RPM_COUNT=0
          DMG_COUNT=0
          EXE_COUNT=0
          for archive_name in $ARCHIVE_NAMES; do
            DEB_COUNT=$((DEB_COUNT + $(compgen -G "$archive_name/*.deb" | wc -l || true)))
            RPM_COUNT=$((RPM_COUNT + $(compgen -G "$archive_name/*.rpm" | wc -l || true)))
            DMG_COUNT=$((DMG_COUNT + $(compgen -G "$archive_name/*.dmg" | wc -l || true)))
            EXE_COUNT=$((EXE_COUNT + $(compgen -G "$archive_name/*setup.exe" | wc -l || true)))
          done

          if [ "$DEB_COUNT" -lt 8 ] && [ "$RPM_COUNT" -lt 8 ]; then
            echo "Error: Less than 8 Debian or 8 RPM packages found (expected 8 for static+dynamic variants)."
            exit 1
          fi

          if [ "$DMG_COUNT" -lt 2 ]; then
            echo "Error: Less than 2 macOS DMG packages found (expected 2 for static+dynamic variants)."
            exit 1
          fi

          if [ "$EXE_COUNT" -lt 1 ]; then
            echo "Error: No Windows executable found."
            exit 1
          fi

      - name: Push to package.cosmian.com
        shell: bash
        run: |
          set -ex
          if [[ "${GITHUB_REF}" =~ 'refs/tags/' ]]; then
            BRANCH="${GITHUB_REF_NAME}"
          else
            BRANCH="last_build/${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          fi
          DESTINATION_DIR=/mnt/package/${{ inputs.destination }}/$BRANCH
          ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p $DESTINATION_DIR

          # Copy Debian, RPM, DMG, and EXE artifacts using ARCHIVE_NAMES patterns
          for dir in $ARCHIVE_NAMES; do
            # Debian
            if compgen -G "$dir/*.deb*" > /dev/null; then
              scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa $dir/*.deb* cosmian@package.cosmian.com:$DESTINATION_DIR/
            fi
            # RPM
            if compgen -G "$dir/*.rpm*" > /dev/null; then
              scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa $dir/*.rpm* cosmian@package.cosmian.com:$DESTINATION_DIR/
            fi
            # DMG (macOS)
            if compgen -G "$dir/*.dmg*" > /dev/null; then
              scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa $dir/*.dmg* cosmian@package.cosmian.com:$DESTINATION_DIR/
            fi
          done

          # Hash artifacts produced by packaging (result-*/bin/*.sha256)
          for dir in hash-*; do
            if [ -d "$dir" ] && compgen -G "$dir/result-*/bin/*.sha256" > /dev/null; then
              scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa \
                $dir/result-*/bin/*.sha256 \
                cosmian@package.cosmian.com:$DESTINATION_DIR/
            fi
          done

          # Include Cosmian public GPG key
          for dir in fips_*ubuntu-24.04-*${{ inputs.debug_or_release }}; do
            if [ -d "$dir" ] && compgen -G "$dir/result-deb-fips*/cosmian-kms-public.asc" > /dev/null; then
              scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa \
                $dir/result-deb-fips*/cosmian-kms-public.asc \
                cosmian@package.cosmian.com:$DESTINATION_DIR/
              break  # Only need to copy once since the key is the same
            fi
          done

          # Windows EXE packages (kept separate because path differs from ARCHIVE_NAMES patterns)
          if compgen -G "windows-release/*setup.exe" > /dev/null; then
            scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa \
              windows-release/*setup.exe \
              cosmian@package.cosmian.com:$DESTINATION_DIR/
          fi

      - name: Release on tags, attach asset on release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            # Debian packages (match both x86_64 and ARM, under result-* folders)
            fips_ubuntu-24.04-*/result-*/*.deb*
            non-fips_ubuntu-24.04-*/result-*/*.deb*
            fips_ubuntu-24.04-arm-*/result-*/*.deb*
            non-fips_ubuntu-24.04-arm-*/result-*/*.deb*

            # RPM packages (match both x86_64 and ARM, under result-* folders)
            fips_ubuntu-24.04-*/result-*/*.rpm*
            non-fips_ubuntu-24.04-*/result-*/*.rpm*
            fips_ubuntu-24.04-arm-*/result-*/*.rpm*
            non-fips_ubuntu-24.04-arm-*/result-*/*.rpm*

            # macOS DMG packages (non-FIPS, under result-* folder)
            non-fips_macos-15-*/result-*/*.dmg*

            # Windows EXE packages
            windows-release/*.exe

            # Hash artifacts from result-*/bin
            hash-ubuntu-24.04-*-*/result-*/bin/*.sha256
            hash-ubuntu-24.04-arm-*-*/result-*/bin/*.sha256
            hash-macos-15-*-*/result-*/bin/*.sha256

            # Include Cosmian public GPG key
            fips_*ubuntu-24.04-*/result-deb-fips*/cosmian-kms-public.asc
