---
name: Push artifacts to package.cosmian.com

on:
  workflow_call:
    inputs:
      project-name:
        required: true
        type: string
      destination:
        required: true
        type: string
      debug_or_release:
        required: true
        type: string

jobs:
  ##############################################################################
  ### Packages
  ##############################################################################
  packages:
    name: push ${{ inputs.project-name }} to package.cosmian.com
    runs-on: [self-hosted, not-sgx]
    container:
      image: cosmian/docker_doc_ci
      volumes:
        - /home/cosmian/.ssh/id_rsa:/root/.ssh/id_rsa

    # Each artifact contains 1 Debian package + 1 RPM package (now doubled for static and dynamic)
    env:
      ARCHIVE_NAMES: >-
        fips_static_ubuntu-24.04-${{ inputs.debug_or_release }}/result-*
        fips_dynamic_ubuntu-24.04-${{ inputs.debug_or_release }}/result-*
        non-fips_static_ubuntu-24.04-${{ inputs.debug_or_release }}/result-*
        non-fips_dynamic_ubuntu-24.04-${{ inputs.debug_or_release }}/result-*
        fips_static_ubuntu-24.04-arm-${{ inputs.debug_or_release }}/result-*
        fips_dynamic_ubuntu-24.04-arm-${{ inputs.debug_or_release }}/result-*
        non-fips_static_ubuntu-24.04-arm-${{ inputs.debug_or_release }}/result-*
        non-fips_dynamic_ubuntu-24.04-arm-${{ inputs.debug_or_release }}/result-*
        non-fips_static_macos-15-${{ inputs.debug_or_release }}/result-*
        non-fips_dynamic_macos-15-${{ inputs.debug_or_release }}/result-*
        target/release

    steps:
      - run: rm -rf ${{ inputs.project-name }}_* fips_* windows* ubuntu* macos* rockylinux* debian* cargo-* hash-* *setup.exe target *osmian*
      - uses: actions/download-artifact@v6
        with:
          pattern: '*fips*'
      - uses: actions/download-artifact@v6
        with:
          pattern: windows-release
      - uses: actions/download-artifact@v6
        with:
          pattern: hash-*

      - run: find .

      - name: Fail if expected number of packages is incorrect
        shell: bash
        run: |
          set -ex
          DEB_COUNT=0
          RPM_COUNT=0
          DMG_COUNT=0
          EXE_COUNT=0
          for archive_name in $ARCHIVE_NAMES; do
            DEB_COUNT=$((DEB_COUNT + $(compgen -G "$archive_name/*.deb" | wc -l || true)))
            RPM_COUNT=$((RPM_COUNT + $(compgen -G "$archive_name/*.rpm" | wc -l || true)))
            DMG_COUNT=$((DMG_COUNT + $(compgen -G "$archive_name/*.dmg" | wc -l || true)))
            EXE_COUNT=$((EXE_COUNT + $(compgen -G "$archive_name/*.exe" | wc -l || true)))
          done

          if [ "$DEB_COUNT" -lt 8 ] && [ "$RPM_COUNT" -lt 8 ]; then
            echo "Error: Less than 8 Debian or 8 RPM packages found (expected 8 for static+dynamic variants)."
            exit 1
          fi

          if [ "$DMG_COUNT" -lt 2 ]; then
            echo "Error: Less than 2 macOS DMG packages found (expected 2 for static+dynamic variants)."
            exit 1
          fi

          if [ "$EXE_COUNT" -lt 1 ]; then
            echo "Error: No Windows executable found."
            exit 1
          fi

      - name: Push to package.cosmian.com
        shell: bash
        run: |
          set -ex
          if [[ "${GITHUB_REF}" =~ 'refs/tags/' ]]; then
            BRANCH="${GITHUB_REF_NAME}"
          else
            BRANCH="last_build/${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          fi
          DESTINATION_DIR=/mnt/package/${{ inputs.destination }}/$BRANCH
          ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p $DESTINATION_DIR

          map_arch() {
            local runner="$1"
            case "$runner" in
              *ubuntu-24.04-arm*) echo "arm64" ;;
              *ubuntu-24.04*) echo "amd64" ;;
              *macos-15*) echo "arm64" ;;
              *windows*) echo "amd64" ;;
              *) echo "amd64" ;;
            esac
          }

          map_type_from_ext() {
            case "$1" in
              *.deb*) echo "debian" ;;
              *.rpm*) echo "rpm" ;;
              *.dmg*) echo "macos" ;;
              *.exe*) echo "windows" ;;
              *) echo "unknown" ;;
            esac
          }

          # Copy Debian, RPM, DMG artifacts, renaming and placing in new tree
          for dir in $ARCHIVE_NAMES; do
            # Extract feature/link/runner from directory name when present
            base_dir=$(dirname "$dir")
            feat=""; link=""; runner="";
            if [[ "$base_dir" =~ ^(fips|non-fips)_(static|dynamic)_(ubuntu-24\.04|ubuntu-24\.04-arm|macos-15)- ]]; then
              feat="${BASH_REMATCH[1]}"
              link="${BASH_REMATCH[2]}"
              runner="${BASH_REMATCH[3]}"
            fi

            for f in "$dir"/*.{deb,rpm,dmg}; do
              [ -e "$f" ] || continue
              pkg_type=$(map_type_from_ext "$f")
              arch=$(map_arch "$runner")
              # Normalize link name to *_openssl
              if [[ "$link" == "static" ]]; then link_n="static-openssl"; else link_n="dynamic-openssl"; fi
              remote_subdir="$DESTINATION_DIR/$pkg_type/$arch/$feat/$link_n"
              ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p "$remote_subdir"
              # Packages are already correctly named; upload without renaming
              scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$f" "cosmian@package.cosmian.com:$remote_subdir/"
            done
          done

          # Hash artifacts produced by packaging: place into matching subfolders
          for dir in hash-*; do
            [ -d "$dir" ] || continue
            # dir pattern: hash-<runner>-<features>-<link>
            if [[ "$dir" =~ ^hash-(ubuntu-24\.04|ubuntu-24\.04-arm|macos-15)-(fips|non-fips)-(static|dynamic)$ ]]; then
              runner="${BASH_REMATCH[1]}"; feat="${BASH_REMATCH[2]}"; link="${BASH_REMATCH[3]}"
              arch=$(map_arch "$runner")
              if [[ "$link" == "static" ]]; then link_n="static-openssl"; else link_n="dynamic-openssl"; fi
              # Hash files
              for h in "$dir"/result-*/bin/*.sha256; do
                [ -e "$h" ] || continue
                # Send to appropriate package type folders
                case "$runner" in
                  ubuntu-24.04|ubuntu-24.04-arm)
                    for pkg_type in debian rpm; do
                      remote_subdir="$DESTINATION_DIR/$pkg_type/$arch/$feat/$link_n"
                      ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p "$remote_subdir"
                      scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$h" "cosmian@package.cosmian.com:$remote_subdir/"
                    done
                    ;;
                  macos-15)
                    remote_subdir="$DESTINATION_DIR/macos/$arch/$feat/$link_n"
                    ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p "$remote_subdir"
                    scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$h" "cosmian@package.cosmian.com:$remote_subdir/"
                    ;;
                esac
              done
            fi
          done

          # Include Cosmian public GPG key (keep at branch root)
          for dir in fips_*ubuntu-24.04-*${{ inputs.debug_or_release }}; do
            if [ -d "$dir" ] && compgen -G "$dir/result-deb-fips*/cosmian-kms-public.asc" > /dev/null; then
              scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa \
                $dir/result-deb-fips*/cosmian-kms-public.asc \
                cosmian@package.cosmian.com:$DESTINATION_DIR/
              break
            fi
          done

          # Windows EXE packages: non-fips static-openssl amd64
          if compgen -G "target/release/*.exe" > /dev/null; then
            arch="amd64"; feat="non-fips"; link_n="static-openssl"
            remote_subdir="$DESTINATION_DIR/windows/$arch/$feat/$link_n"
            ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p "$remote_subdir"
            for exe in target/release/*.exe; do
              [ -e "$exe" ] || continue
              # Upload already-named installer without renaming
              scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$exe" "cosmian@package.cosmian.com:$remote_subdir/"
            done
          fi

      - name: Release on tags, attach asset on release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            # Debian packages (match both x86_64 and ARM, under result-* folders)
            fips_ubuntu-24.04-*/result-*/*.deb*
            non-fips_ubuntu-24.04-*/result-*/*.deb*
            fips_ubuntu-24.04-arm-*/result-*/*.deb*
            non-fips_ubuntu-24.04-arm-*/result-*/*.deb*

            # RPM packages (match both x86_64 and ARM, under result-* folders)
            fips_ubuntu-24.04-*/result-*/*.rpm*
            non-fips_ubuntu-24.04-*/result-*/*.rpm*
            fips_ubuntu-24.04-arm-*/result-*/*.rpm*
            non-fips_ubuntu-24.04-arm-*/result-*/*.rpm*

            # macOS DMG packages (non-FIPS, under result-* folder)
            non-fips_macos-15-*/result-*/*.dmg*

            # Windows EXE packages
            target/release/*.exe

            # Hash artifacts from result-*/bin
            hash-ubuntu-24.04-*-*/result-*/bin/*.sha256
            hash-ubuntu-24.04-arm-*-*/result-*/bin/*.sha256
            hash-macos-15-*-*/result-*/bin/*.sha256

            # Include Cosmian public GPG key
            fips_*ubuntu-24.04-*/result-deb-fips*/cosmian-kms-public.asc
