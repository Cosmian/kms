---
name: Windows Build

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string
      archive-name:
        required: true
        type: string

jobs:
  cargo-build:
    name: windows-2022-non-fips
    runs-on: windows-2022
    steps:
      - name: Print ENV
        run: printenv

      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.toolchain }}
          components: rustfmt, clippy

      - name: Discover environment variables on Runner
        shell: pwsh
        run: |
          Get-ChildItem env:

      - name: Locate VCPKG_INSTALLATION_ROOT
        shell: pwsh
        run: |
          Get-ChildItem $env:VCPKG_INSTALLATION_ROOT

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Build UI
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          . .\.github\scripts\windows_ui.ps1
          Build-UI -Variant non-fips

      - name: Copy UI to server directory
        shell: pwsh
        run: |
          if (Test-Path "crate\server\ui_non_fips") {
            Remove-Item -Recurse -Force "crate\server\ui_non_fips"
          }
          New-Item -ItemType Directory -Path "crate\server\ui_non_fips" -Force
          Copy-Item -Recurse "ui\dist\*" "crate\server\ui_non_fips\"
          Write-Host "UI copied to crate\server\ui_non_fips"
          Get-ChildItem -Recurse "crate\server\ui_non_fips"

      - name: Build static OpenSSL
        shell: pwsh
        run: |
          vcpkg install --triplet x64-windows-static
          vcpkg integrate install

          Get-ChildItem -Recurse "$env:VCPKG_INSTALLATION_ROOT\packages"

      - name: Build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          . .\.github\scripts\cargo_build.ps1
          BuildProject

      - name: Rename installer to new convention
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          # Extract version from workspace Cargo.toml
          $cargoToml = Get-Content -Raw "Cargo.toml"
          $inWorkspace = $false
          $version = ""
          foreach ($line in $cargoToml -split "`n") {
            if ($line -match '^\[workspace\.package\]') { $inWorkspace = $true; continue }
            if ($inWorkspace -and $line -match '^version\s*=\s*"([^"]+)"') { $version = $Matches[1]; break }
            if ($inWorkspace -and $line -match '^\[') { break }
          }
          if (-not $version) { throw "Unable to parse version from Cargo.toml" }
          $arch = "x86_64"
          Get-ChildItem -Path "target/release" -Filter "*setup.exe" | ForEach-Object {
            $newName = "cosmian-kms-server-non-fips-static-openssl_${version}_${arch}.exe"
            $dest = Join-Path $_.DirectoryName $newName
            Move-Item -Force $_.FullName $dest
            Write-Host "Renamed $($_.Name) -> $newName"
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.archive-name }}-release
          path: |
            README.md
            target/release/*server*.exe
          retention-days: 1
          if-no-files-found: error

  test:
    needs: cargo-build
    name: windows-2022 - test on clean env. ${{ inputs.archive-name }}
    runs-on: windows-2022
    steps:
      - uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.archive-name }}-release

      - name: List files recursively
        shell: pwsh
        run: Get-ChildItem -Recurse

      - name: Launch binaries
        run: |
          Get-ChildItem -Filter "cosmian*.exe" | ForEach-Object {
            Write-Host "Testing $_..."
            & $_.FullName -V
          }

  publish-windows-release:
    name: Publish Windows assets (self-hosted container)
    needs: cargo-build
    runs-on: [self-hosted, not-sgx]
    container:
      image: cosmian/docker_doc_ci
      volumes:
        - /home/cosmian/.ssh/id_rsa:/root/.ssh/id_rsa

    steps:
      - name: Checkout repository (for release metadata)
        uses: actions/checkout@v6
        with:
          submodules: false

      - name: Download Windows build artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.archive-name }}-release
          path: .

      - name: List downloaded files
        run: |
          set -ex
          ls -la
          find . -maxdepth 3 -type f -print

      - name: Push installer to package.cosmian.com
        shell: bash
        run: |
          set -ex
          if [[ "${GITHUB_REF}" =~ refs/tags/(.+) ]]; then
            BRANCH="${BASH_REMATCH[1]}"
          else
            HEAD_REF="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
            BRANCH="last_build/${HEAD_REF}"
          fi
          DEST_DIR="/mnt/package/kms/${BRANCH}/windows/x86_64/non-fips/static-openssl"
          ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p "$DEST_DIR"
          while IFS= read -r -d '' exe; do
            echo "Uploading ${exe} to ${DEST_DIR}"
            scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$exe" "cosmian@package.cosmian.com:${DEST_DIR}"
          done < <(find . -maxdepth 3 -type f -name 'cosmian-kms-server*.exe' -print0)

      - name: Publish GitHub Release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            cosmian-kms-server*.exe
            ./nix/signing-keys/cosmian-kms-public.asc
