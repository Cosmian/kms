---
name: Windows Build

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string
      archive-name:
        required: true
        type: string

jobs:
  cargo-build:
    name: windows-2022-non-fips
    runs-on: windows-2022
    steps:
      - name: Print ENV
        run: printenv

      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.toolchain }}
          components: rustfmt, clippy

      - name: Discover environment variables on Runner
        shell: pwsh
        run: |
          Get-ChildItem env:

      - name: Locate VCPKG_INSTALLATION_ROOT
        shell: pwsh
        run: |
          Get-ChildItem $env:VCPKG_INSTALLATION_ROOT

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Build UI
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          . .\.github\scripts\windows_ui.ps1
          Build-UI -Variant non-fips

      - name: Copy UI to server directory
        shell: pwsh
        run: |
          if (Test-Path "crate\server\ui_non_fips") {
            Remove-Item -Recurse -Force "crate\server\ui_non_fips"
          }
          New-Item -ItemType Directory -Path "crate\server\ui_non_fips" -Force
          Copy-Item -Recurse "ui\dist\*" "crate\server\ui_non_fips\"
          Write-Host "UI copied to crate\server\ui_non_fips"
          Get-ChildItem -Recurse "crate\server\ui_non_fips"

      - name: Build static OpenSSL
        shell: pwsh
        run: |
          vcpkg install --triplet x64-windows-static
          vcpkg integrate install

          Get-ChildItem -Recurse "$env:VCPKG_INSTALLATION_ROOT\packages"

      - name: Build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          . .\.github\scripts\cargo_build.ps1
          BuildProject

      - name: Rename installer to new convention
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          # Extract version from workspace Cargo.toml
          $cargoToml = Get-Content -Raw "Cargo.toml"
          $inWorkspace = $false
          $version = ""
          foreach ($line in $cargoToml -split "`n") {
            if ($line -match '^\[workspace\.package\]') { $inWorkspace = $true; continue }
            if ($inWorkspace -and $line -match '^version\s*=\s*"([^"]+)"') { $version = $Matches[1]; break }
            if ($inWorkspace -and $line -match '^\[') { break }
          }
          if (-not $version) { throw "Unable to parse version from Cargo.toml" }
          $arch = "amd64"
          Get-ChildItem -Path "target/release" -Filter "*setup.exe" | ForEach-Object {
            $newName = "cosmian-kms-server-non-fips-static-openssl_${version}_${arch}.exe"
            $dest = Join-Path $_.DirectoryName $newName
            Move-Item -Force $_.FullName $dest
            Write-Host "Renamed $($_.Name) -> $newName"
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.archive-name }}-release
          path: |
            README.md
            target/release/*server*.exe
          retention-days: 1
          if-no-files-found: error

  test:
    needs: cargo-build
    name: windows-2022 - test on clean env. ${{ inputs.archive-name }}
    runs-on: windows-2022
    steps:
      - uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.archive-name }}-release

      - name: List files recursively
        shell: pwsh
        run: Get-ChildItem -Recurse

      - name: Launch binaries
        run: |
          Get-ChildItem -Filter "cosmian*.exe" | ForEach-Object {
            Write-Host "Testing $_..."
            & $_.FullName -V
          }
