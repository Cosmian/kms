---
name: CI checks

on:
  push:

jobs:
  cargo-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: EmbarkStudios/cargo-deny-action@v1

  cargo-lint:
    uses: ./.github/workflows/clippy.yml
    with:
      toolchain: nightly-2024-06-09

  build_tests:
    uses: ./.github/workflows/build_all.yml
    secrets: inherit
    with:
      toolchain: nightly-2024-06-09

  clean_env_test:
    name: ${{ matrix.archive_name }} -> Launch binary in a clean env. -> ${{ matrix.os }}
    needs:
      - build_tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - archive_name: centos7-debug
            kms_path: .
            os: ubuntu-20.04

          - archive_name: fips_centos7-debug
            kms_path: __w/kms/kms/target/x86_64-unknown-linux-gnu/debug
            os: ubuntu-20.04

          - archive_name: rhel9-debug
            kms_path: debug
            os: ubuntu-22.04

          - archive_name: fips_ubuntu_20_04-debug
            kms_path: home/runner/work/kms/kms/target/x86_64-unknown-linux-gnu/debug
            os: ubuntu-20.04

          - archive_name: ubuntu_22_04-debug
            kms_path: debug
            os: ubuntu-22.04

          - archive_name: ubuntu_24_04-debug
            kms_path: debug
            os: ubuntu-24.04

          - archive_name: macos-debug
            kms_path: debug
            os: macos-12

          - archive_name: macos14-debug
            kms_path: debug
            os: macos-14

          - archive_name: windows_tests
            kms_path: .
            os: windows-2022

    steps:
      - uses: actions/download-artifact@v3

      - run: find .
        if: contains(runner.os, 'linux')

      - name: Launch ckms and cosmian_kms_server
        if: contains(runner.os, 'Linux') || contains(runner.os, 'macos')
        run: |
          set -ex

          chmod u+x ./${{ matrix.archive_name }}/${{ matrix.kms_path }}/ckms
          chmod u+x ./${{ matrix.archive_name }}/${{ matrix.kms_path }}/cosmian_kms_server

          ./${{ matrix.archive_name }}/${{ matrix.kms_path }}/ckms -V

          # Copy openssl build for FIPS mode
          if [ -d "${{ matrix.archive_name }}/usr/local/openssl" ]; then
            sudo mkdir /usr/local/openssl
            sudo chown -R $USER /usr/local/openssl
            rsync -ru ${{ matrix.archive_name }}/usr/local/openssl/ /usr/local/openssl/
            chmod u+x /usr/local/openssl/lib64/ossl-modules/fips.so
            ldd /usr/local/openssl/lib64/ossl-modules/fips.so
          fi
          ./${{ matrix.archive_name }}/${{ matrix.kms_path }}/cosmian_kms_server -V

      - name: Launch ckms and cosmian_kms_server
        if: contains(runner.os, 'windows')
        run: |
          ${{ matrix.archive_name }}/${{ matrix.kms_path }}/ckms.exe -V
          ${{ matrix.archive_name }}/${{ matrix.kms_path }}/cosmian_kms_server.exe -V

  cargo-doc:
    uses: Cosmian/reusable_workflows/.github/workflows/cargo-doc.yml@develop
    with:
      toolchain: nightly-2024-06-09

  python_and_docker:
    uses: ./.github/workflows/build_and_test_docker_image.yml

  public_documentation:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Deploy documentation in staging
        if: ${{ github.ref_name == 'develop' }}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: staging.yml
          repo: Cosmian/public_documentation
          ref: develop
          token: ${{ secrets.PAT_TOKEN }}
