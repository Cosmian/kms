---
name: Packaging

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string
        default: 1.90.0
  workflow_dispatch:
    inputs:
      toolchain:
        description: Rust toolchain to use (e.g., stable, nightly-YYYY-MM-DD)
        required: true
        type: string
        default: 1.90.0

jobs:
  windows-package:
    uses: ./.github/workflows/build_windows.yml
    with:
      toolchain: ${{ inputs.toolchain }}
      archive-name: windows

  docker:
    uses: ./.github/workflows/packaging-docker.yml
    with:
      toolchain: ${{ inputs.toolchain }}

  packages:
    name: ${{ matrix.runner }} - ${{ matrix.features }} - ${{ matrix.link }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        features: [fips, non-fips]
        link: [static, dynamic]
        runner: [ubuntu-24.04, ubuntu-24.04-arm, macos-15]

    steps:
      - name: Nix installation
        uses: cachix/install-nix-action@v31

      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up GPG
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_SIGNING_KEY }}
          passphrase: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE }}

      - name: List keys
        run: gpg -K

      - name: Package
        run: |
          bash .github/scripts/nix.sh --profile release --variant ${{ matrix.features }} --link ${{ matrix.link }} package
        env:
          GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}
          GPG_SIGNING_KEY_PASSPHRASE: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE }}

      - name: Upload package
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.features }}_${{ matrix.link }}_${{ matrix.runner }}-release
          path: result-*-${{ matrix.features }}-${{ matrix.link }}/*
          retention-days: 1
          if-no-files-found: error

  publish-release:
    name: Publish release assets (self-hosted container)
    needs: packages
    runs-on: [self-hosted, not-sgx]
    container:
      image: cosmian/docker_doc_ci
      volumes:
        - /home/cosmian/.ssh/id_rsa:/root/.ssh/id_rsa

    strategy:
      fail-fast: false
      matrix:
        features: [fips, non-fips]
        link: [static, dynamic]
        runner: [ubuntu-24.04, ubuntu-24.04-arm, macos-15]
    steps:
      - name: Checkout repository (for public key file)
        uses: actions/checkout@v6
        with:
          submodules: false

      - name: Download packaged artifact for this matrix
        uses: actions/download-artifact@v6
        with:
          name: ${{ matrix.features }}_${{ matrix.link }}_${{ matrix.runner }}-release

      - name: List downloaded assets
        run: |
          set -ex
          ls -la
          find . -maxdepth 2 -type f -print

      - name: Push to package.cosmian.com (self-hosted)
        shell: bash
        run: |
          set -ex
          if [[ "${GITHUB_REF}" =~ 'refs/tags/' ]]; then
            BRANCH="${GITHUB_REF_NAME}"
          else
            BRANCH="last_build/${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          fi
          DESTINATION_DIR=/mnt/package/kms/$BRANCH/
          ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p "$DESTINATION_DIR"

          map_arch() {
            local runner="$1"
            case "$runner" in
              *ubuntu-24.04-arm*) echo "arm64" ;;
              *ubuntu-24.04*) echo "amd64" ;;
              *macos-15*) echo "arm64" ;;
              *) echo "amd64" ;;
            esac
          }

          map_type_from_ext() {
            case "$1" in
              *.deb*) echo "debian" ;;
              *.rpm*) echo "rpm" ;;
              *.dmg*) echo "macos" ;;
              *) echo "unknown" ;;
            esac
          }

          ARCH=$(map_arch "${{ matrix.runner }}")
          for file in result-*-${{ matrix.features }}-${{ matrix.link }}/*; do
            filename=$(basename "$file")
            type=$(map_type_from_ext "$filename")
            remote_dir="${DESTINATION_DIR}/${type}/${ARCH}/${{ matrix.features }}/${{ matrix.link }}/${filename}"
            remote_path="${remote_dir}/${filename}"
            ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p "$remote_dir"
            echo "Uploading $file to $remote_path"
            scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$file" "cosmian@package.cosmian.com:$remote_path"
          done

          # Include Cosmian public GPG key for package verification
          scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa ./nix/signing-keys/cosmian-kms-public.asc "cosmian@package.cosmian.com:$DESTINATION_DIR"

      - name: Publish GitHub Release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            result-*-${{ matrix.features }}-${{ matrix.link }}/*
            ./nix/signing-keys/cosmian-kms-public.asc

  tests:
    needs: packages
    uses: ./.github/workflows/packaging-tests.yml
    with:
      toolchain: ${{ inputs.toolchain }}
