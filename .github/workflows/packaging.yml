---
name: Packaging

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string
        default: 1.90.0
  workflow_dispatch:
    inputs:
      toolchain:
        description: Rust toolchain to use (e.g., stable, nightly-YYYY-MM-DD)
        required: true
        type: string
        default: 1.90.0

jobs:
  windows-package:
    uses: ./.github/workflows/build_windows.yml
    with:
      toolchain: ${{ inputs.toolchain }}
      archive-name: windows

  docker:
    uses: ./.github/workflows/packaging-docker.yml
    with:
      toolchain: ${{ inputs.toolchain }}

  packages:
    name: ${{ matrix.runner }}-${{ matrix.features }}-${{ matrix.link }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        features: [fips, non-fips]
        link: [static, dynamic]
        runner: [ubuntu-24.04, ubuntu-24.04-arm, macos-15]

    steps:
      - name: Nix installation
        uses: cachix/install-nix-action@v31

      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up GPG
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_SIGNING_KEY }}
          passphrase: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE }}

      - name: List keys
        run: gpg -K

      - name: Package
        run: |
          bash .github/scripts/nix.sh --profile release --variant ${{ matrix.features }} --link ${{ matrix.link }} package
        env:
          GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}
          GPG_SIGNING_KEY_PASSPHRASE: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE }}

      - name: Upload package
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.features }}_${{ matrix.link }}_${{ matrix.runner }}-release
          path: result-*-${{ matrix.features }}-${{ matrix.link }}/*
          retention-days: 1
          if-no-files-found: error

  publish-release:
    name: Publish ${{ matrix.runner }}-${{ matrix.features }}-${{ matrix.link }}
    needs: packages
    runs-on: [self-hosted, not-sgx]
    container:
      image: cosmian/docker_doc_ci
      volumes:
        - /home/cosmian/.ssh/id_rsa:/root/.ssh/id_rsa

    strategy:
      fail-fast: false
      matrix:
        features: [fips, non-fips]
        link: [static, dynamic]
        include:
          - runner: ubuntu-24.04
            arch: amd64
          - runner: ubuntu-24.04
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
          - runner: ubuntu-24.04-arm
            arch: arm64
          - runner: macos-15
            arch: arm64
        type: [deb, rpm, dmg]
    steps:
      - name: Checkout repository (for public key file)
        uses: actions/checkout@v6
        with:
          submodules: false

      - name: Download packaged artifact for this matrix
        uses: actions/download-artifact@v6
        with:
          name: ${{ matrix.features }}_${{ matrix.link }}_${{ matrix.runner }}-release

      - name: List downloaded assets
        run: |
          set -ex
          ls -la
          find . -type f -print

      - name: Push to package.cosmian.com (self-hosted)
        shell: bash
        run: |
          set -ex
          if [[ "${GITHUB_REF}" =~ 'refs/tags/' ]]; then
            BRANCH="${GITHUB_REF_NAME}"
          else
            BRANCH="last_build/${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          fi
          DESTINATION_DIR=/mnt/package/kms/$BRANCH
          ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p "$DESTINATION_DIR"

          # Upload exactly the three expected artifacts from the known result directory
          RESULT_DIR="result-${{ matrix.type }}-${{ matrix.features }}-${{ matrix.link }}"
          RESULT_SERVER_DIR="result-server-${{ matrix.features }}-${{ matrix.link }}/bin"
          remote_dir="${DESTINATION_DIR}/${{ matrix.type }}/${{ matrix.arch }}/${{ matrix.features }}/${{ matrix.link }}"
          ssh -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa cosmian@package.cosmian.com mkdir -p "$remote_dir"

          # Detect package file by type
          case "${{ matrix.type }}" in
            deb)
              pkg_ext="deb"
              ;;
            rpm)
              pkg_ext="rpm"
              ;;
            dmg)
              pkg_ext="dmg"
              ;;
            *)
              echo "Unknown package type: ${{ matrix.type }}" >&2
              exit 1
              ;;
          esac

          pkg_file=$(ls -1 "$RESULT_DIR"/*."$pkg_ext" 2>/dev/null | head -n1 || true)
          asc_file=$(ls -1 "$RESULT_DIR"/*.asc 2>/dev/null | head -n1 || true)
          sha_file=$(ls -1 "$RESULT_DIR"/*.sha256 2>/dev/null | head -n1 || true)
          server_sha_file=$(ls -1 "$RESULT_SERVER_DIR"/*.sha256 2>/dev/null | head -n1 || true)

          # Upload present files; warn if missing
          if [[ -n "$pkg_file" ]]; then
            echo "Uploading package: $pkg_file"
            scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$pkg_file" "cosmian@package.cosmian.com:${remote_dir}/$(basename "$pkg_file")"
          else
            echo "Warning: package file not found in $RESULT_DIR"
          fi

          if [[ -n "$asc_file" ]]; then
            echo "Uploading signature: $asc_file"
            scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$asc_file" "cosmian@package.cosmian.com:${remote_dir}/$(basename "$asc_file")"
          else
            echo "Warning: signature (.asc) not found in $RESULT_DIR"
          fi

          if [[ -n "$sha_file" ]]; then
            echo "Uploading hash: $sha_file"
            scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$sha_file" "cosmian@package.cosmian.com:${remote_dir}/$(basename "$sha_file")"
          else
            echo "Warning: hash (.sha256) not found in $RESULT_DIR"
          fi

          if [[ -n "$server_sha_file" ]]; then
            echo "Uploading hash: $server_sha_file"
            scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa "$server_sha_file" "cosmian@package.cosmian.com:${remote_dir}/$(basename "$server_sha_file")"
          else
            echo "Warning: hash (.sha256) not found in $RESULT_SERVER_DIR"
          fi

          # Include Cosmian public GPG key for package verification
          scp -o 'StrictHostKeyChecking no' -i /root/.ssh/id_rsa ./nix/signing-keys/cosmian-kms-public.asc "cosmian@package.cosmian.com:${DESTINATION_DIR}"

      - name: Publish GitHub Release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            result-*-${{ matrix.features }}-${{ matrix.link }}/*
            ./nix/signing-keys/cosmian-kms-public.asc

  tests:
    needs: packages
    uses: ./.github/workflows/packaging-tests.yml
    with:
      toolchain: ${{ inputs.toolchain }}
