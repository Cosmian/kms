---
name: Packaging

on:
  workflow_call:
    inputs:
      toolchain:
        required: true
        type: string
        default: 1.90.0
  workflow_dispatch:
    inputs:
      toolchain:
        description: Rust toolchain to use (e.g., stable, nightly-YYYY-MM-DD)
        required: true
        type: string
        default: 1.90.0

jobs:
  windows-package:
    uses: ./.github/workflows/build_windows.yml
    with:
      toolchain: ${{ inputs.toolchain }}
      archive-name: windows

  docker:
    uses: ./.github/workflows/packaging-docker.yml
    with:
      toolchain: ${{ inputs.toolchain }}

  packages:
    name: ${{ matrix.runner }} - ${{ matrix.features }} - ${{ matrix.link }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        features: [fips, non-fips]
        link: [static, dynamic]
        runner: [ubuntu-24.04, ubuntu-24.04-arm, macos-15]

    steps:
      - name: Nix installation
        uses: cachix/install-nix-action@v31

      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up GPG
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_SIGNING_KEY }}
          passphrase: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE }}

      - name: List keys
        run: gpg -K

      - name: Package
        run: |
          bash .github/scripts/nix.sh --profile release --variant ${{ matrix.features }} --link ${{ matrix.link }} package
        env:
          GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}
          GPG_SIGNING_KEY_PASSPHRASE: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE }}

      - name: Upload hash artifact
        uses: actions/upload-artifact@v5
        with:
          name: hash-${{ matrix.runner }}-${{ matrix.features }}-${{ matrix.link }}
          path: result*/bin/cosmian-kms-server.${{ matrix.features }}*.sha256
          retention-days: 1
          if-no-files-found: error

      - name: Upload package
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.features }}_${{ matrix.link }}_${{ matrix.runner }}-release
          path: result-*-${{ matrix.features }}-${{ matrix.link }}/*
          retention-days: 1
          if-no-files-found: error

  tests:
    needs: packages
    uses: ./.github/workflows/packaging-tests.yml
    with:
      toolchain: ${{ inputs.toolchain }}

  push-artifacts:
    if: github.repository == 'Cosmian/kms' && !startsWith(github.ref_name, 'dependabot/')
    needs:
      - windows-package
      - tests
      - docker
    uses: ./.github/workflows/push-artifacts.yml
    with:
      project-name: kms
      destination: kms
      debug_or_release: release
